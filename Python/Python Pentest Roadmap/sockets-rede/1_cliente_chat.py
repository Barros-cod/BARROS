import socket
import threading
import sys 

HOST = '127.0.0.1'  
PORT = 65432

def receber_mensagens(s):
    try:
        while True:
            data = s.recv(1024)
            if not data:
                print("\n[DESCONEXÃO] O servidor encerrou a conexão.")

            print(f"\n{data.decode('utf-8')}")
            print("Sua mensagem: ", end="", flush=True)
    except OSError: 
        print("\n[ERRO DE CONEXÃO] Conexão com o servidor perdida.")
        sys.exit()
    except Exception as e:
        print(f"\n[ERRO INESPERADO AO RECEBER] {e}")
        sys.exit()

def iniciar_cliente():
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        try:
            s.connect((HOST, PORT))
            print(f"Conectado ao servidor de chat em {HOST}:{PORT}")

            receive_thread = threading.Thread(target=receber_mensagens, args=(s,))
            receive_thread.daemon = True 
            receive_thread.start()

            while True:
                message = input("Sua mensagem: ")
                if message.lower() == 'sair':
                    break
                s.sendall(message.encode('utf-8'))

        except ConnectionRefusedError:
            print("Erro: Não foi possível conectar ao servidor. Verifique se o servidor está rodando.")
        except Exception as e:
            print(f"Um erro ocorreu: {e}")
        finally:
            print("Desconectando do servidor.")
            s.close()
if __name__ == "__main__":
    iniciar_cliente()